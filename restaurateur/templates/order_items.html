{% extends 'base_restaurateur_page.html' %}

{% block title %}Необработанные заказы | Star Burger{% endblock %}

{% block content %}
  <center>
    <h2>Необработанные заказы</h2>
  </center>

  <hr/>
  
  <div class="container">
    <div class="row" style="margin-bottom: 20px;">
      <div class="col-md-12">
        <form method="get" class="form-inline">
          <div class="form-group">
            <div class="input-group">
              <input type="text" name="q" class="form-control" placeholder="Поиск по клиенту, телефону, адресу..." 
                     value="{{ search_query }}" style="width: 300px;">
              <span class="input-group-btn">
                <button class="btn btn-default" type="submit">
                  <span class="glyphicon glyphicon-search"></span> Найти
                </button>
              </span>
            </div>
          </div>
          
          <div class="form-group" style="margin-left: 20px;">
            <label for="status" style="margin-right: 10px;">Статус:</label>
            <select name="status" id="status" class="form-control">
              <option value="">Все активные</option>
              <option value="new" {% if status_filter == 'new' %}selected{% endif %}>Новые</option>
              <option value="processing" {% if status_filter == 'processing' %}selected{% endif %}>В обработке</option>
              <option value="cooking" {% if status_filter == 'cooking' %}selected{% endif %}>Готовятся</option>
              <option value="delivering" {% if status_filter == 'delivering' %}selected{% endif %}>Доставляются</option>
              <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Выполненные</option>
              <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Отмененные</option>
            </select>
          </div>
          
          <button type="submit" class="btn btn-primary" style="margin-left: 10px;">Применить</button>
          <a href="{% url 'restaurateur:view_orders' %}" class="btn btn-default" style="margin-left: 10px;">Сбросить</a>
        </form>
      </div>
    </div>

    {% if search_query or status_filter %}
    <div class="row" style="margin-bottom: 15px;">
      <div class="col-md-12">
        <div class="alert alert-info">
          <strong>Найдено заказов:</strong> {{ orders_with_restaurants|length }}
          {% if search_query %} по запросу "{{ search_query }}"{% endif %}
          {% if status_filter %} со статусом "{{ status_filter }}"{% endif %}
        </div>
      </div>
    </div>
    {% endif %}

   <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>ID</th>
        <th>Статус</th>
        <th>Клиент</th>
        <th>Телефон</th>
        <th>Адрес</th>
        <th>Способ оплаты</th>
        <th>Ресторан</th>
        <th>Комментарий</th>
        <th>Сумма</th>
        <th>Товары</th>
        <th>Время</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody>
    {% for order_data in orders_with_restaurants %}
      {% with order=order_data.order %}
      <tr>
        <td><strong>#{{ order.id }}</strong></td>
        <td>
          <span class="label label-{% if order.status == 'new' %}warning
                                  {% elif order.status == 'processing' %}info
                                  {% elif order.status == 'cooking' %}primary
                                  {% elif order.status == 'delivering' %}success
                                  {% elif order.status == 'completed' %}default
                                  {% else %}danger{% endif %}">
            {{ order.get_status_display }}
          </span>
        </td>
        <td>{{ order.firstname }} {{ order.lastname }}</td>
        <td>{{ order.phonenumber }}</td>
        <td>{{ order.address }}</td>
        <td>
          <span class="label label-{% if order.payment_method == 'cash' %}info
                                  {% elif order.payment_method == 'card' %}success
                                  {% else %}primary{% endif %}">
            {{ order.get_payment_method_display }}
          </span>
        </td>
        <td>
          {% if order.assigned_restaurant %}
            <strong>{{ order.assigned_restaurant.name }}</strong>
          {% elif order_data.available_restaurants %}
            <div class="restaurant-info">
              <strong>Могут приготовить:</strong>
              <ul class="list-unstyled">
                {% for restaurant in order_data.available_restaurants %}
                <li>
                  <small>{{ restaurant.name }}</small>
                  {% if restaurant.address %}
                    <br><small class="text-muted">{{ restaurant.address }}</small>
                  {% endif %}
                </li>
                {% endfor %}
              </ul>
            </div>
          {% else %}
            <span class="text-danger">Нет подходящих ресторанов</span>
          {% endif %}
        </td>
        <td>
          {% if order.comment %}
            <span class="comment-tooltip" title="{{ order.comment }}">
              {{ order.comment|truncatewords:3 }}
            </span>
          {% else %}
            <span class="text-muted">—</span>
          {% endif %}
        </td>
        <td><strong>{{ order.get_total }} руб.</strong></td>
        <td>
          <ul class="list-unstyled" style="margin-bottom: 0;">
            {% for item in order.items.all %}
            <li><small>{{ item.product.name }} × {{ item.quantity }}</small></li>
            {% endfor %}
          </ul>
        </td>
        <td>
          <small>
            <div>Создан: {{ order.created_at|date:"d.m.Y H:i" }}</div>
            {% if order.called_at %}
            <div>Звонок: {{ order.called_at|date:"d.m.Y H:i" }}</div>
            {% endif %}
            {% if order.delivered_at %}
            <div>Доставка: {{ order.delivered_at|date:"d.m.Y H:i" }}</div>
            {% endif %}
          </small>
        </td>
        <td>
          <a href="{% url 'admin:foodcartapp_order_change' order.id %}?next={% url 'restaurateur:view_orders' %}" 
            class="btn btn-default btn-xs" target="_blank" title="Редактировать заказ">
            <span class="glyphicon glyphicon-edit"></span>
          </a>
        </td>
      </tr>
      {% endwith %}
    {% empty %}
      <tr>
        <td colspan="12" class="text-center">
          <div class="alert alert-warning">
            <h4>{% if search_query or status_filter %}Заказы не найдены{% else %}Нет активных заказов{% endif %}</h4>
            <p>
              {% if search_query %}По запросу "{{ search_query }}" ничего не найдено.{% endif %}
              {% if status_filter %}С выбранным статусом заказов нет.{% endif %}
              {% if not search_query and not status_filter %}Все заказы обработаны или новых пока нет.{% endif %}
            </p>
          </div>
        </td>
      </tr>
    {% endfor %}
    </tbody>
   </table>
  </div>
{% endblock %}